name: API Tests (Postman + Newman)

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      # 1Ô∏è‚É£ Checkout test repo (current repo)
      - name: Checkout tests repo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Checkout backend repo
      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: silumi95/automation-engineer-test-be
          path: backend

      # 3Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 4Ô∏è‚É£ Install backend dependencies
      - name: Install backend dependencies
        working-directory: backend
        run: npm install

      # 5Ô∏è‚É£ Install required tools
      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd curl jq

      # 6Ô∏è‚É£ Wait for MongoDB
      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB..."
          for i in {1..30}; do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 2
          done

      # 7Ô∏è‚É£ Setup backend environment
      - name: Setup backend environment
        working-directory: backend
        run: |
          echo "PORT=8000" > .env
          echo "MONGO_URI=mongodb://127.0.0.1:27017/qa_test_db" >> .env
          echo "NODE_ENV=development" >> .env
          echo "JWT_SECRET=test-jwt-secret-for-ci-12345-67890" >> .env
          echo "Environment file created:"
          cat .env

      # 8Ô∏è‚É£ Seed test admin user (ES Module version)
      - name: Seed test admin user
        working-directory: backend
        run: |
          # Create ES module seed script
          cat > seed-admin.mjs << 'EOF'
          import mongoose from 'mongoose';
          import bcrypt from 'bcryptjs';
          
          async function seedAdmin() {
            try {
              console.log('Connecting to MongoDB for seeding...');
              await mongoose.connect('mongodb://127.0.0.1:27017/qa_test_db');
              
              // Drop database to start fresh
              await mongoose.connection.db.dropDatabase();
              console.log('Database cleared');
              
              let User;
              try {
                // Try to import User model
                const userModule = await import('./models/User.js');
                User = userModule.default;
              } catch (e) {
                console.log('Creating User schema...');
                // Create simple User schema if model doesn't exist
                const userSchema = new mongoose.Schema({
                  name: String,
                  email: { type: String, unique: true },
                  password: String,
                  role: { type: String, enum: ['worker', 'admin'], default: 'worker' }
                });
                User = mongoose.model('User', userSchema);
              }
              
              // Create admin user
              const hashedPassword = await bcrypt.hash('AdminPass123!', 10);
              const admin = new User({
                name: 'Test Admin',
                email: 'admin@example.com',
                password: hashedPassword,
                role: 'admin'
              });
              
              await admin.save();
              console.log('‚úÖ Test admin user created');
              
              // Create a test worker user
              const workerPassword = await bcrypt.hash('WorkerPass123!', 10);
              const worker = new User({
                name: 'Test Worker',
                email: 'worker@example.com',
                password: workerPassword,
                role: 'worker'
              });
              
              await worker.save();
              console.log('‚úÖ Test worker user created');
              
              await mongoose.disconnect();
              console.log('‚úÖ Seeding completed');
            } catch (error) {
              console.error('‚ùå Error seeding:', error.message);
              console.error(error.stack);
              process.exit(1);
            }
          }
          
          seedAdmin();
          EOF
          
          echo "Running seed script..."
          node seed-admin.mjs

      # 9Ô∏è‚É£ Start backend server
      - name: Start backend server
        working-directory: backend
        run: |
          echo "Starting backend server..."
          
          # Start server in background with output to log file
          nohup node server.js > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          echo "Waiting for server to start (PID: $SERVER_PID)..."
          
          # Wait for server to start
          for i in {1..30}; do
            if curl -s -f http://localhost:8000 > /dev/null 2>&1; then
              echo "‚úÖ Backend server is responding"
              
              # Test basic endpoints
              echo "Testing health endpoint..."
              curl -s http://localhost:8000/health || curl -s http://localhost:8000/api/health || echo "No health endpoint"
              
              echo "Testing register endpoint..."
              curl -X POST http://localhost:8000/api/user/register \
                -H "Content-Type: application/json" \
                -d '{"name":"CI Test","email":"ci@test.com","password":"CITest123!"}' \
                -s -w " Status: %{http_code}" || echo "Register test failed"
                
              break
            fi
            sleep 2
          done
          
          # If server didn't start, show logs and exit
          if ! ps -p $SERVER_PID > /dev/null 2>&1; then
            echo "‚ùå Server process died"
            if [ -f server.log ]; then
              echo "Server logs:"
              tail -50 server.log
            fi
            exit 1
          fi
          
          if ! curl -s -f http://localhost:8000 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Server running but not responding. Logs:"
            tail -50 server.log
          fi

      # üîü Install Newman
      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      # 1Ô∏è‚É£1Ô∏è‚É£ Update Postman environment for CI
      - name: Update Postman environment
        run: |
          # Check if environment file exists
          if [ -f "postman/QA Environment.postman_environment.json" ]; then
            echo "Updating Postman environment file..."
            
            # Create a backup
            cp "postman/QA Environment.postman_environment.json" "postman/QA Environment.postman_environment.json.backup"
            
            # Update using jq
            jq '
              .values |= map(
                if .key == "baseUrl" then .value = "http://localhost:8000"
                elif .key == "adminEmail" then .value = "admin@example.com"
                elif .key == "adminPassword" then .value = "AdminPass123!"
                else .
                end
              )
            ' "postman/QA Environment.postman_environment.json" > "postman/QA Environment-CI.json"
            
            echo "Updated environment:"
            cat "postman/QA Environment-CI.json" | jq '.values[] | select(.key == "baseUrl" or .key == "adminEmail" or .key == "adminPassword")'
          else
            echo "Creating new environment file..."
            cat > "postman/QA Environment-CI.json" << 'EOF'
            {
              "id": "ci-environment",
              "name": "CI Environment",
              "values": [
                {
                  "key": "baseUrl",
                  "value": "http://localhost:8000",
                  "enabled": true
                },
                {
                  "key": "adminEmail",
                  "value": "admin@example.com",
                  "enabled": true
                },
                {
                  "key": "adminPassword",
                  "value": "AdminPass123!",
                  "enabled": true
                },
                {
                  "key": "jwtToken",
                  "value": "",
                  "enabled": true
                },
                {
                  "key": "adminJwtToken",
                  "value": "",
                  "enabled": true
                },
                {
                  "key": "userId",
                  "value": "",
                  "enabled": true
                },
                {
                  "key": "shiftId",
                  "value": "",
                  "enabled": true
                }
              ]
            }
            EOF
          fi

      # 1Ô∏è‚É£2Ô∏è‚É£ Run Postman collection
      - name: Run Postman collection
        run: |
          echo "Starting Postman tests..."
          
          # Check if environment file exists
          if [ ! -f "postman/QA Environment-CI.json" ]; then
            echo "Error: Environment file not found"
            exit 1
          fi
          
          # Run Newman tests
          newman run "postman/E2E Shift Management.postman_collection.json" \
            -e "postman/QA Environment-CI.json" \
            --env-var "baseUrl=http://localhost:8000" \
            --env-var "adminEmail=admin@example.com" \
            --env-var "adminPassword=AdminPass123!" \
            --timeout 180000 \
            --timeout-request 30000 \
            --timeout-script 30000 \
            --disable-unicode \
            -r cli,json,htmlextra \
            --reporter-json-export newman-report.json \
            --reporter-htmlextra-export newman-report.html \
            --verbose

      # 1Ô∏è‚É£3Ô∏è‚É£ Show server logs if tests fail
      - name: Show server logs on failure
        if: failure()
        working-directory: backend
        run: |
          echo "=== SERVER LOGS ==="
          if [ -f server.log ]; then
            tail -100 server.log
          else
            echo "No server logs found"
          fi
          
          echo "=== NETSTAT ==="
          netstat -tulpn | grep :8000 || echo "No process on port 8000"

      # 1Ô∏è‚É£4Ô∏è‚É£ Stop backend server
      - name: Stop backend server
        if: always()
        working-directory: backend
        run: |
          echo "Cleaning up..."
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            echo "Stopping server with PID: $PID"
            kill $PID 2>/dev/null || true
            sleep 2
            kill -9 $PID 2>/dev/null || true
            rm -f server.pid
          fi
          
          # Clean up any remaining node processes
          pkill -f "node.*server" 2>/dev/null || true

      # 1Ô∏è‚É£5Ô∏è‚É£ Upload reports
      - name: Upload Newman report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            newman-report.json
            newman-report.html
            backend/server.log
          retention-days: 7