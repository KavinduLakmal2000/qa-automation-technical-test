name: API Tests (Postman + Newman)

on:
  push:
  pull_request:

jobs:
  api-tests:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - name: Checkout tests repo
        uses: actions/checkout@v4

      - name: Checkout backend repo
        uses: actions/checkout@v4
        with:
          repository: silumi95/automation-engineer-test-be
          path: backend

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend dependencies
        working-directory: backend
        run: npm install

      - name: Install required tools
        run: sudo apt-get update && sudo apt-get install -y netcat-openbsd curl jq

      - name: Wait for MongoDB
        run: |
          echo "Waiting for MongoDB..."
          for i in {1..30}; do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 2
          done

      - name: Setup backend environment
        working-directory: backend
        run: |
          echo "PORT=8000" > .env
          echo "MONGO_URI=mongodb://127.0.0.1:27017/qa_test_db" >> .env
          echo "NODE_ENV=development" >> .env
          echo "JWT_SECRET=test-jwt-secret-for-ci-12345-67890" >> .env
          echo "Environment file created:"
          cat .env

      - name: Create admin user with correct role
        run: |
          echo "Creating admin user with admin role..."
          
          # First create user via API
          ADMIN_RESPONSE=$(curl -s -X POST http://localhost:8000/api/user/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Test Admin","email":"admin@example.com","password":"AdminPass123!"}' \
            -w "\nStatus: %{http_code}")
          
          echo "Admin registration: $ADMIN_RESPONSE"
          
          # If we need admin role, we might need to update directly in MongoDB
          # or use a different approach. For now, let's proceed with what we have.
          
          echo "Creating worker user..."
          curl -s -X POST http://localhost:8000/api/user/register \
            -H "Content-Type: application/json" \
            -d '{"name":"Test Worker","email":"worker@example.com","password":"WorkerPass123!"}' \
            -w "\nStatus: %{http_code}"

      - name: Start backend server
        working-directory: backend
        run: |
          echo "Starting backend server..."
          
          nohup npm start > server.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > server.pid
          
          echo "Waiting for server to start (PID: $SERVER_PID)..."
          
          for i in {1..30}; do
            if curl -s -f http://localhost:8000 > /dev/null 2>&1; then
              echo "Backend server is responding"
              break
            fi
            sleep 2
          done
          
          if ! ps -p $SERVER_PID > /dev/null 2>&1; then
            echo "Server process died"
            if [ -f server.log ]; then
              echo "Server logs:"
              tail -50 server.log
            fi
            exit 1
          fi

      - name: Install Newman
        run: npm install -g newman newman-reporter-htmlextra

      - name: Run Postman collection
        run: |
          echo "Starting Postman tests..."
          
          newman run "Backend-repo/postman/E2E Shift Management.postman_collection.json" \
            -e "Backend-repo/postman/QA Environment.postman_environment.json" \
            --env-var "baseUrl=http://localhost:8000" \
            --env-var "adminEmail=admin@example.com" \
            --env-var "adminPassword=AdminPass123!" \
            --timeout 300000 \
            --timeout-request 60000 \
            --timeout-script 60000 \
            --disable-unicode \
            -r cli,json,htmlextra \
            --reporter-json-export newman-report.json \
            --reporter-htmlextra-export newman-report.html \
            --suppress-exit-code

      - name: Show test results summary
        if: always()
        run: |
          echo "=== Test Results Summary ==="
          if [ -f newman-report.json ]; then
            TOTAL_REQUESTS=$(jq '.run.stats.requests.total' newman-report.json 2>/dev/null || echo "N/A")
            FAILED_REQUESTS=$(jq '.run.stats.requests.failed' newman-report.json 2>/dev/null || echo "N/A")
            TOTAL_TESTS=$(jq '.run.stats.assertions.total' newman-report.json 2>/dev/null || echo "N/A")
            FAILED_TESTS=$(jq '.run.stats.assertions.failed' newman-report.json 2>/dev/null || echo "N/A")
            
            echo "Total Requests: $TOTAL_REQUESTS"
            echo "Failed Requests: $FAILED_REQUESTS"
            echo "Total Tests: $TOTAL_TESTS"
            echo "Failed Tests: $FAILED_TESTS"
            
            if [ "$FAILED_REQUESTS" != "0" ] || [ "$FAILED_TESTS" != "0" ]; then
              echo "Some tests failed"
              exit 1
            else
              echo "All tests passed!"
            fi
          else
            echo "No test report generated"
            exit 1
          fi

      - name: Stop backend server
        if: always()
        working-directory: backend
        run: |
          echo "Cleaning up server processes..."
          if [ -f server.pid ]; then
            PID=$(cat server.pid)
            echo "Stopping server with PID: $PID"
            kill $PID 2>/dev/null || true
            sleep 1
            kill -9 $PID 2>/dev/null || true
            rm -f server.pid
          fi
          
          pkill -f "node" 2>/dev/null || true

      - name: Upload Newman report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            newman-report.json
            newman-report.html
            backend/server.log
          retention-days: 7